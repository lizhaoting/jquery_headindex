;(function(n){var s=function(){function e(e,t){this.settings=n.extend(true,n.fn.headIndex.default,t||{});this.element=e;this.init()}e.prototype={init:function(){var e=n(this.settings.articleWrap);this.headerList=e.find(":header");this.indexBox=n(this.settings.indexBox);this.scrollBody=n(this.settings.scrollSelector);this.manual=false;if(this.indexBox.length===0||this.headerList.length===0){return null}this.initHeader();this.event()},initHeader:function(){for(var e=0;e<this.headerList.length;e++,this.autoId++){this.headerList[e].id=this.headerList[e].id||"header-id-"+this.autoId;this.headerList[e].topHeight=this.offsetTop(this.headerList[e]);this.headerList[e].h=Number(this.headerList[e].tagName.charAt(1))}this.indexTree=[];this.indexHtml="";this.buildTree();this.buildHtml(this.indexTree);if(this.indexHtml){var t="<ul>"+this.indexHtml+"</ul>";this.indexBox.html(t)}},updateTopHeight:function(){var e=this.headerList.length;var t;if(e===0)return;if(this.headerList[0].topHeight===this.offsetTop(this.headerList[0])&&this.headerList[e-1].topHeight===this.offsetTop(this.headerList[e-1])){return}if(this.headerList[0].topHeight-this.offsetTop(this.headerList[0])===this.headerList[e-1].topHeight-this.offsetTop(this.headerList[e-1])){var i=this.offsetTop(this.headerList[0])-this.headerList[0].topHeight;for(t=0;t<this.headerList.length;t++,this.autoId++){this.headerList[t].topHeight+=i}return}for(t=0;t<this.headerList.length;t++,this.autoId++){this.headerList[t].topHeight=this.offsetTop(this.headerList[t])}},event:function(){var s=this;var h=null;this.indexBox.on("click.headindex",function(e){var t=n(e.target);if(t.hasClass(s.settings.linkClass)){e.preventDefault();var i=t.parent("."+s.settings.itemClass);s.manual=true;if(h){clearTimeout(h);h=null}h=setTimeout(function(){s.manual=false},300);s.current(i);s.scrollBody.stop().animate({scrollTop:s.offsetTop(document.querySelector(e.target.getAttribute("href")))},"fast")}});n(window).scroll(function(){if(s.manual)return;var e=s.scrollBody.scrollTop();s.updateTopHeight();var t=s.search(0,s.headerList.length,e);if(!t){return}var i=s.indexBox.find('a[href="#'+t.id+'"]').parent("li."+s.settings.itemClass);s.current(i)})},current:function(e){var t,i="current";if(!e.hasClass(i)){var s=this.indexBox.find("li."+i);if(s.length>0){s.removeClass(i)}this.indexBox.find("ul.open").removeClass("open");t=e.children("."+this.settings.subItemBoxClass);if(t.length>0){t.addClass("open").slideDown()}var h=e.parents("ul."+this.settings.subItemBoxClass);if(h.length>0){h.addClass("open").slideDown()}t=this.indexBox.find("ul."+this.settings.subItemBoxClass).not(".open");if(t.length>0){t.slideUp()}e.addClass(i)}},buildHtml:function(e){if(e===undefined||e.length===0)return;for(var t=0;t<e.length;t++){this.indexHtml+="<li class='"+this.settings.itemClass+"'>"+"<a class='"+this.settings.linkClass+"' href='#"+e[t].item.id+"'>"+e[t].item.innerText+"</a>";if(e[t].children.length!==0){this.indexHtml+="<ul class='"+this.settings.subItemBoxClass+"'>";this.buildHtml(e[t].children);this.indexHtml+="</ul>"}this.indexHtml+="</li>"}},buildTree:function(){var e=null;var t;for(var i=0;i<this.headerList.length;i++){if(e==null){e={item:this.headerList[i],parent:null,children:[]};this.indexTree.push(e)}else{if(e.item.h<this.headerList[i].h){t={item:this.headerList[i],parent:e,children:[]};e.children.push(t);e=t}else if(e.item.h===this.headerList[i].h){t={item:this.headerList[i],parent:e.parent,children:[]};(e.parent&&e.parent.children||this.indexTree).push(t);e=t}else{while(e!=null&&e.item.h>this.headerList[i].h){e=e.parent}if(e==null){e={item:this.headerList[i],parent:null,children:[]};this.indexTree.push(e)}else{if(e.item.h<this.headerList[i].h){t={item:this.headerList[i],parent:e,children:[]};e.children.push(t);e=t}else if(e.item.h===this.headerList[i].h){t={item:this.headerList[i],parent:e.parent,children:[]};(e.parent&&e.parent.children||this.indexTree).push(t);e=t}}}}}},search:function(e,t,i){if(this.headerList.length===0)return null;if(t-e<=1){if(this.headerList[t].topHeight<i){return this.headerList[t]}return this.headerList[e]}if(e<t){var s=parseInt((e+t)/2);var h=this.headerList[s].topHeight;if(i<h){t=s}else if(i>h){e=s}else{return this.headerList[s]}return this.search(e,t,i)}},offsetTop:function(e){var t,i;if(!e){return}if(!e.getClientRects().length){return{top:0,left:0}}t=e.getBoundingClientRect();i=e.ownerDocument.defaultView;return parseInt(t.top+i.pageYOffset)}};e.prototype.autoId=1;return e}();n.fn.headIndex=function(i){return this.each(function(){var e=n(this),t=e.data("headIndex");if(!t){t=new s(e,i);e.data("headIndex",t)}if(n.type(i)==="string")return t[i]()})};n.fn.headIndex.default={articleWrap:".article-wrap",indexBox:".index-box",scrollSelector:"body,html",subItemBoxClass:"index-subItem-box",itemClass:"index-item",linkClass:"index-link"}})(jQuery);